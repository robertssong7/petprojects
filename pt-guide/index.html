<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physical Therapy Guide</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Load Babel (to handle JSX in the browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Styles -->
    <style>
        /* Custom animations usually handled by Tailwind config, added manually here */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes zoomIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .animate-in { animation-duration: 0.5s; animation-fill-mode: both; }
        .fade-in { animation-name: fadeIn; }
        .slide-in-from-bottom-4 { animation-name: slideUp; }
        .slide-in-from-right-8 { animation-name: slideUp; /* Simplified to slideUp for HTML version */ }
        .zoom-in-95 { animation-name: zoomIn; }
        
        .animate-bounce-short {
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div id="root"></div>

    <!-- 5. Application Code -->
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- Icons (Inlined for simplicity in HTML) ---
        const LucideActivity = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        );
        const LucideAlertCircle = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
        );
        const LucideInfo = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
        );
        const LucideCheckCircle2 = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>
        );
        const LucideAlertTriangle = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
        );

        // --- Configuration ---

        const PAIN_QUALITIES = [
            "Sharp or stabbing",
            "Dull or aching",
            "Burning or hot",
            "Throbbing or pulsating",
            "Shooting or electric",
            "Cramping or spasmodic",
            "Tingling or pins and needles",
            "Numb or heavy",
        ];

        const DURATION_OPTIONS = [
            "1–3 days",
            "3–7 days",
            "1–2 weeks",
            "More than 2 weeks",
        ];

        // Expanded to 8 items for symmetry
        const FRONT_REGIONS = [
            { id: "head-front", label: "Head & Neck" },
            { id: "shoulder-front", label: "Shoulders" },
            { id: "arm-front", label: "Arms & Elbows" },
            { id: "hand-front", label: "Hands & Wrists" },
            { id: "torso-front", label: "Chest & Abs" },
            { id: "hip-front", label: "Hips & Pelvis" },
            { id: "upper-leg-front", label: "Thigh & Knee" },
            { id: "lower-leg-front", label: "Shin, Ankle & Foot" },
        ];

        const BACK_REGIONS = [
            { id: "head-back", label: "Head & Neck" },
            { id: "shoulder-back", label: "Shoulder Blades" },
            { id: "arm-back", label: "Arms & Elbows" },
            { id: "hand-back", label: "Hands & Wrists" },
            { id: "torso-back", label: "Mid & Low Back" },
            { id: "hip-back", label: "Hips & Glutes" },
            { id: "upper-leg-back", label: "Hamstring & Knee" },
            { id: "lower-leg-back", label: "Calf, Ankle & Foot" },
        ];

        // --- Helpers ---

        function getRegionsForSide(side) {
            return side === "back" ? BACK_REGIONS : FRONT_REGIONS;
        }

        function getRegionLabels(side, selectedIds) {
            const regionMap = new Map(
                getRegionsForSide(side).map((r) => [r.id, r.label])
            );
            return selectedIds.map((id) => regionMap.get(id)).filter(Boolean);
        }

        function getZoomStyle(regionId) {
            if (!regionId) return "scale-100 origin-center";

            if (regionId.includes("head")) return "scale-[2.8] origin-[50%_5%]";
            if (regionId.includes("shoulder")) return "scale-[2.5] origin-[50%_20%]";
            if (regionId.includes("arm")) return "scale-[2.0] origin-[50%_35%]";
            if (regionId.includes("hand")) return "scale-[2.5] origin-[20%_45%]";
            if (regionId.includes("torso")) return "scale-[2.2] origin-[50%_30%]";
            if (regionId.includes("hip")) return "scale-[2.4] origin-[50%_48%]";
            if (regionId.includes("upper-leg")) return "scale-[2.4] origin-[50%_65%]";
            // Shifted origin to 105% to pull the feet up
            if (regionId.includes("lower-leg")) return "scale-[2.8] origin-[50%_105%]";

            return "scale-150 origin-center";
        }

        function computeSeverity({ intensity, duration, qualities = [], notes = "" }) {
            let score = 0;
            const notesLower = notes.toLowerCase();

            // 1. INTENSITY
            if (intensity >= 8) score += 4;
            else if (intensity >= 6) score += 2;
            else if (intensity >= 4) score += 1;

            // 2. DURATION
            if (duration === "1–2 weeks") score += 1;
            if (duration === "More than 2 weeks") score += 2;

            // 3. QUALITIES
            const concernQualities = [
                "Sharp or stabbing",
                "Shooting or electric",
                "Throbbing or pulsating",
                "Numb or heavy"
            ];
            const hasConcern = qualities.some((q) => concernQualities.includes(q));
            if (hasConcern) score += 2;

            // 4. FUNCTIONAL LOSS
            const redFlags = ["walk", "weight", "buckl", "fall", "numb", "urine", "bladder", "fever", "night"];
            const hasRedFlag = redFlags.some(flag => notesLower.includes(flag));
            
            if (hasRedFlag && intensity > 3) {
                score += 3;
            }

            if (score <= 2) return "green";
            if (score <= 5) return "yellow";
            return "orange";
        }

        function makePlan({ severity, regionLabels }) {
            const areaText = regionLabels.length ? regionLabels.join(", ") : "this area";

            let title = `Support for your ${areaText}`;
            let steps = [];

            if (severity === "orange") {
                title = `Clinician evaluation recommended`;
                steps = [
                    `Your symptoms (high intensity, sharp quality, or functional difficulty) suggest a potential structural issue or acute injury in the ${areaText}.`,
                    "We recommend seeing a Physical Therapist or Physician to rule out fractures, ligament tears, or severe nerve compression.",
                    "**Immediate Action:** Protect the area. If it hurts to bear weight, do not force it. Use crutches or support if available.",
                    "Apply ice for 15-20 minutes every few hours to control acute inflammation.",
                    "Avoid 'testing' the pain. If a movement hurts, stop immediately.",
                ];
            } else if (severity === "yellow") {
                title = `Active monitoring & modification`;
                steps = [
                    `Your symptoms in the ${areaText} are moderate. This often indicates tissue irritation or a minor strain.`,
                    "Modify, don't stop: Reduce the intensity of your activities by 50% for 3-5 days.",
                    "Gentle motion is medicine. Stiffness makes it worse, but sharp pain means stop.",
                    "If the pain does not trend down after 5 days, or if you notice swelling, schedule an appointment.",
                ];
            } else {
                title = `Self-management routine`;
                steps = [
                    `Your profile suggests a mechanical ache or mild tension in the ${areaText} that often responds well to movement.`,
                    "Motion is lotion: Avoid staying in one position for more than 30 minutes.",
                    "It is safe to move through mild discomfort (pain level < 3/10).",
                    "Focus on gradual strengthening and mobility exercises (see below).",
                ];
            }

            return { title, steps };
        }

        function makeIssues({ severity, regionLabels, notes = "", qualities = [], duration = "", intensity }) {
            const areaText = regionLabels.length ? regionLabels.join(", ") : "the area you selected";

            const baseIssues = [
                {
                    id: "structural-compromise",
                    title: "Potential Structural/Joint Issue",
                    description: `High intensity or sharp pain, especially if causing difficulty moving or bearing weight, may indicate a sprain, internal joint issue (like meniscus/labrum), or bone stress.`,
                    remedyShort: "Protect + Clinician Eval",
                },
                {
                    id: "acute-inflammation",
                    title: "Acute Inflammation",
                    description: `Throbbing or hot sensations often mean the tissue is actively inflamed (e.g., tendonitis or bursitis).`,
                    remedyShort: "Ice + Relative Rest",
                },
                {
                    id: "soft-tissue",
                    title: "Muscular Tension/Strain",
                    description: `Muscles in the ${areaText} may be in protective spasm or mildly strained.`,
                    remedyShort: "Heat + Gentle Massage",
                },
                {
                    id: "stiffness",
                    title: "Joint Hypomobility (Stiffness)",
                    description: `The joints in the ${areaText} may be restricted, forcing muscles to work overtime.`,
                    remedyShort: "Daily Mobility Drills",
                },
                {
                    id: "movement-pattern",
                    title: "Movement/Postural Habits",
                    description: `How you sit, stand, or move the ${areaText} repeatedly might be the root cause.`,
                    remedyShort: "Ergonomic Check",
                },
                {
                    id: "impact",
                    title: "Load/Impact Sensitivity",
                    description: `The tissues may currently lack the capacity for high-impact loads (running/jumping).`,
                    remedyShort: "Unload + Low Impact",
                },
                {
                    id: "overuse",
                    title: "Repetitive Overuse",
                    description: `Doing too much, too soon, or for too long without adequate recovery.`,
                    remedyShort: "Pacing + Micro-breaks",
                },
                {
                    id: "neural-tension",
                    title: "Neural Sensitivity",
                    description: `Nerves travelling through the ${areaText} may be irritated or compressed.`,
                    remedyShort: "Nerve Glides (No Stretching)",
                },
                {
                    id: "core-control",
                    title: "Stability Deficit",
                    description: `Lack of deep stability may be causing the ${areaText} to compensate and overwork.`,
                    remedyShort: "Activation Exercises",
                },
                {
                    id: "knee-tracking",
                    title: "Patellofemoral Tracking",
                    description: `Alignment issues at the knee cap often cause sharp front-knee pain.`,
                    remedyShort: "Hip Strengthening",
                },
                {
                    id: "foot-arch",
                    title: "Foot Biomechanics",
                    description: `Issues with arch support or foot mobility often refer pain up the chain.`,
                    remedyShort: "Foot Intrinsics",
                },
            ];

            const notesLower = notes.toLowerCase();
            const areaLower = areaText.toLowerCase();
            const isChronic = duration === "More than 2 weeks" || duration === "1–2 weeks";
            const isAcute = !isChronic;

            const scoreIssue = (issue) => {
                let score = 10;
                const strongKeywords = (words) => words.some(w => w && (notesLower.includes(w)));
                const weakKeywords = (words) => words.some(w => w && (notesLower.includes(w)));
                const hasQuality = (qList) => qualities.some(q => qList.includes(q));

                switch (issue.id) {
                    case "structural-compromise":
                        if (intensity >= 7) score += 20;
                        if (hasQuality(["Sharp or stabbing", "Shooting or electric"])) score += 15;
                        if (strongKeywords(["pop", "snap", "give way", "buckle", "lock", "swollen", "bruise"])) score += 30;
                        if (strongKeywords(["walk", "weight", "limp", "stair"])) score += 20;
                        if (isAcute) score += 10;
                        break;
                    case "acute-inflammation":
                        if (hasQuality(["Throbbing or pulsating", "Burning or hot"])) score += 30;
                        if (strongKeywords(["swoll", "puff", "hot", "red"])) score += 25;
                        if (isAcute) score += 10;
                        break;
                    case "soft-tissue":
                        score += 5; 
                        if (intensity < 6) score += 10;
                        if (strongKeywords(["tight", "knot", "sore", "rub", "stiff"])) score += 15;
                        if (hasQuality(["Dull or aching", "Cramping or spasmodic"])) score += 15;
                        break;
                    case "stiffness":
                        if (strongKeywords(["stuck", "locked", "frozen", "bend", "reach"])) score += 25;
                        if (weakKeywords(["morning", "start", "warm up"])) score += 15;
                        if (isChronic) score += 10;
                        break;
                    case "movement-pattern":
                        if (strongKeywords(["posture", "slouch", "technique", "form", "desk"])) score += 20;
                        if (isChronic) score += 15;
                        break;
                    case "impact":
                        if (strongKeywords(["land", "pounding", "concrete", "run", "jump"])) score += 25;
                        if (hasQuality(["Throbbing or pulsating", "Sharp or stabbing"])) score += 10;
                        break;
                    case "overuse":
                        if (strongKeywords(["repetitive", "repeat", "typing", "mouse", "keyboard", "lift"])) score += 25;
                        if (weakKeywords(["work", "all day", "hours", "shift"])) score += 15;
                        break;
                    case "neural-tension":
                        if (strongKeywords(["electric", "shock", "zap", "shoot"])) score += 30;
                        if (weakKeywords(["tingle", "numb", "pins", "burn", "radiate"])) score += 20;
                        if (hasQuality(["Shooting or electric", "Tingling or pins and needles", "Numb or heavy"])) score += 40;
                        break;
                    case "core-control":
                        if (strongKeywords(["giving way", "buckle", "collapse"])) score += 25;
                        if (weakKeywords(["weak", "unstable", "wobbly", "tired"])) score += 15;
                        break;
                    case "knee-tracking":
                        if (strongKeywords(["cap", "kneecap", "track", "pop", "stairs"])) score += 25;
                        break;
                    case "foot-arch":
                        if (strongKeywords(["plantar", "arch", "flat", "heel"])) score += 25;
                        break;
                }
                return score;
            };

            let scoredIssues = baseIssues.map(issue => {
                let impossible = false;
                if (issue.id === 'knee-tracking' && !areaLower.includes('knee')) impossible = true;
                if (issue.id === 'foot-arch' && !areaLower.includes('foot') && !areaLower.includes('ankle') && !areaLower.includes('knee') && !areaLower.includes('shin')) impossible = true;
                
                return { 
                    ...issue, 
                    rawScore: impossible ? 0 : scoreIssue(issue) 
                };
            });

            let rankedIssues = scoredIssues.sort((a, b) => b.rawScore - a.rawScore);
            let topIssues = rankedIssues.slice(0, 3);
            
            const top3Sum = topIssues.reduce((acc, i) => acc + i.rawScore, 0);
            topIssues = topIssues.map(i => ({
                ...i,
                confidence: top3Sum > 0 ? Math.round((i.rawScore / top3Sum) * 100) : 0
            }));

            if (severity === "orange") {
                const acuteIdx = topIssues.findIndex(i => i.id === "structural-compromise" || i.id === "acute-inflammation");
                if (acuteIdx > 0) {
                    const acuteIssue = topIssues[acuteIdx];
                    topIssues.splice(acuteIdx, 1);
                    topIssues.unshift(acuteIssue);
                }
            }

            return topIssues;
        }

        function makeIssuePlan({ issueId, regionLabels, severity }) {
            const r = regionLabels.join(" ").toLowerCase();
            const isKnee = r.includes("knee");
            const isBack = r.includes("back") || r.includes("torso");
            const isNeck = r.includes("head") || r.includes("neck");
            const isShoulder = r.includes("shoulder") || r.includes("arm");
            const isFoot = r.includes("foot") || r.includes("ankle");

            const getSpecifics = () => {
                if (isKnee) return { drill: "heel slides (lying on back)", strength: "quad sets (tightening thigh muscle)" };
                if (isBack) return { drill: "gentle pelvic tilts", strength: "abdominal bracing" };
                if (isNeck) return { drill: "chin tucks", strength: "isometric neck holds" };
                if (isShoulder) return { drill: "pendulum swings", strength: "scapular squeezes" };
                if (isFoot) return { drill: "ankle alphabet", strength: "towel scrunches" };
                return { drill: "gentle range of motion", strength: "isometric holds" };
            };
            const { drill, strength } = getSpecifics();

            const base = {
                "structural-compromise": [
                    "**Priority:** Protect the joint. Avoid any activity that causes sharp pain.",
                    "Use 'R.I.C.E' (Rest, Ice, Compression, Elevation) to manage acute symptoms.",
                    "If weight-bearing is painful, consider using crutches or a cane temporarily.",
                    "Consult a clinician for imaging or specific orthopedic testing."
                ],
                "acute-inflammation": [
                    "Apply ice for 15-20 minutes, 3-4 times a day.",
                    "Avoid heat right now, as it may increase swelling.",
                    "Perform very gentle, pain-free movement to prevent stiffness, but do not push into pain.",
                    "Elevate the limb above heart level when resting."
                ],
                "soft-tissue": [
                    "Apply heat for 15 minutes to relax the muscle belly.",
                    "Use gentle self-massage or a foam roller on the tight areas (avoiding bone).",
                    `Follow up with ${drill} to encourage blood flow.`,
                    "Stay hydrated and try to keep moving gently throughout the day."
                ],
                "movement-pattern": [
                    "Set a timer to change your posture every 20-30 minutes.",
                    "Check your workstation ergonomics (screen height, chair support).",
                    "Film yourself performing the painful activity to identify awkward mechanics.",
                    "Focus on 'neutral spine' and relaxed shoulders during daily tasks."
                ],
                "stiffness": [
                    "Motion is lotion: Stiffness improves with frequent, low-load movement.",
                    `Perform ${drill} every morning and evening.`,
                    "A hot shower or heat pack before movement can help loosen the joint.",
                    "Do not force the joint into a painful range; work at the edge of the restriction."
                ],
                "impact": [
                    "Temporarily switch to low-impact cardio (cycling, swimming, elliptical).",
                    "Ensure you have supportive footwear.",
                    "When returning to activity, increase volume by no more than 10% per week.",
                    "Focus on soft, quiet landings during any movement."
                ],
                "overuse": [
                    "Relative Rest: Reduce the volume of the aggravating activity by 50%.",
                    "Break large tasks into smaller chunks with rest breaks.",
                    "Check your equipment (shoes, racket, keyboard) for wear and tear.",
                    "Contrast baths (alternating warm and cool water) can help recovery."
                ],
                "neural-tension": [
                    "**Stop stretching:** Aggressive stretching often irritates nerves.",
                    "Perform gentle 'nerve flossing' (gliding the nerve without tension).",
                    "Focus on slow, diaphragmatic breathing to calm the nervous system.",
                    "Avoid postures that compress the nerve (e.g., crossing legs, sleeping on arm)."
                ],
                "core-control": [
                    `Start with ${strength} to build deep stability.`,
                    "Focus on quality of movement over quantity of reps.",
                    "Engage your core gently (like anticipating a poke) before lifting.",
                    "Avoid hyperextending (arching) your back during overhead tasks."
                ],
                "joint-mobility": [
                    "Use prolonged, gentle holds for mobility (30+ seconds).",
                    "Use a strap or towel to assist the stretch if needed.",
                    "Breathe deeply during the stretch to reduce muscle guarding."
                ],
                "knee-tracking": [
                    "Strengthen the hips (glutes) to help control the knee.",
                    "Practice single-leg balance in front of a mirror, keeping the knee aligned over the 2nd toe.",
                    "Avoid letting the knee cave inward (valgus) during squats or stairs."
                ],
                "foot-arch": [
                    "Practice 'short foot' exercises to build arch strength.",
                    "Calf tightness often pulls on the arch—stretch your calves gently.",
                    "Try barefoot walking on grass or sand to stimulate foot muscles."
                ],
            };

            return base[issueId] || [];
        }

        // --- UI Components ---

        const SeverityBadge = ({ level }) => {
            const map = {
                green: "bg-emerald-50 text-emerald-700 border-emerald-300",
                yellow: "bg-amber-50 text-amber-700 border-amber-300",
                orange: "bg-orange-50 text-orange-700 border-orange-300",
            };
            const iconMap = {
                green: LucideCheckCircle2,
                yellow: LucideInfo,
                orange: LucideAlertTriangle
            };
            const Icon = iconMap[level];

            const text = {
                green: "Low Acuity – Self-Management Appropriate",
                yellow: "Moderate Acuity – Monitor & Modify Activity",
                orange: "High Acuity – Clinician Evaluation Recommended",
            };
            return (
                <div className={`rounded-xl border px-4 py-4 mb-6 flex items-start gap-3 ${map[level] || ""}`}>
                    <div className="mt-0.5"><Icon className="w-5 h-5" /></div>
                    <div>
                        <div className="text-xs font-bold uppercase tracking-wide opacity-80 mb-1">
                            Triage Recommendation
                        </div>
                        <div className="text-sm font-bold">{text[level]}</div>
                    </div>
                </div>
            );
        };

        const Chip = ({ selected, onClick, children }) => (
            <button
                type="button"
                onClick={onClick}
                className={`text-xs md:text-sm rounded-lg px-2 py-3 border text-center transition flex items-center justify-center font-medium ${
                    selected
                        ? "bg-sky-600 text-white border-sky-600 shadow-md ring-1 ring-sky-300"
                        : "bg-white text-slate-600 border-slate-200 hover:bg-slate-50 hover:border-slate-300"
                }`}
            >
                {children}
            </button>
        );

        const StepHeader = ({ step, total, title }) => (
            <div className="mb-4">
                <div className="flex items-center gap-2 mb-1">
                    <div className="text-xs font-bold bg-slate-900 text-white px-2 py-0.5 rounded-full uppercase tracking-wide">
                        Step {step} of {total}
                    </div>
                </div>
                <h2 className="text-xl font-bold text-slate-900">{title}</h2>
            </div>
        );

        const BodySilhouette = ({ side, highlightRegion }) => {
            const isFront = side === "front";
            const highlightShapes = [];
            
            const addBand = (y, h) => {
                highlightShapes.push(
                    <rect key={`band-${y}`} x={18} y={y} width={44} height={h} rx={12} fill="#0ea5e9" fillOpacity={0.18} />
                );
            };

            if (highlightRegion) {
                if (highlightRegion.includes("head")) addBand(4, 30);
                else if (highlightRegion.includes("shoulder")) addBand(34, 16);
                else if (highlightRegion.includes("torso")) addBand(52, 48);
                else if (highlightRegion.includes("hip")) addBand(102, 20);
                else if (highlightRegion.includes("upper-leg")) addBand(124, 36);
                else if (highlightRegion.includes("lower-leg")) addBand(162, 38);
                else if (highlightRegion.includes("arm")) {
                    highlightShapes.push(<path key="arms-l" d="M16 46 L14 90" stroke="#0ea5e9" strokeWidth="10" strokeOpacity="0.18" fill="none" strokeLinecap="round"/>);
                    highlightShapes.push(<path key="arms-r" d="M64 46 L66 90" stroke="#0ea5e9" strokeWidth="10" strokeOpacity="0.18" fill="none" strokeLinecap="round"/>);
                } else if (highlightRegion.includes("hand")) {
                    highlightShapes.push(<circle key="hand-l" cx="14" cy="100" r="8" fill="#0ea5e9" fillOpacity="0.18" />);
                    highlightShapes.push(<circle key="hand-r" cx="66" cy="100" r="8" fill="#0ea5e9" fillOpacity="0.18" />);
                }
            }

            const JointLine = ({ x1, y1, x2, y2 }) => (
                <line x1={x1} y1={y1} x2={x2} y2={y2} stroke="currentColor" strokeWidth="0.8" strokeDasharray="1.5,1.5" opacity="0.7" />
            );

            return (
                <svg viewBox="0 0 80 210" className="w-full h-full text-slate-400" aria-hidden="true">
                    <text x="6" y="20" fontSize="12" fill="currentColor" opacity="0.5">L</text>
                    <text x="62" y="20" fontSize="12" fill="currentColor" opacity="0.5">R</text>
                    
                    {highlightShapes}

                    {/* Head */}
                    <circle cx="40" cy="20" r="12" fill="none" stroke="currentColor" strokeWidth="1.5" />
                    {/* Neck */}
                    <path d="M36 32 L44 32 L42 40 Q40 42 38 40 Z" fill="none" stroke="currentColor" strokeWidth="1.5" />
                    {/* Shoulders/Torso */}
                    <path d="M22 42 Q40 34 58 42 L60 66 Q58 88 40 92 Q22 88 20 66 Z" fill="none" stroke="currentColor" strokeWidth="1.5" />
                    {/* Hips */}
                    <path d="M20 66 Q40 72 60 66 Q58 92 50 104 Q40 110 30 104 Q22 92 20 66 Z" fill="none" stroke="currentColor" strokeWidth="1.5" />
                    {/* Arms */}
                    <path d="M22 46 Q14 70 14 100" fill="none" stroke="currentColor" strokeWidth="1.5" />
                    <path d="M58 46 Q66 70 66 100" fill="none" stroke="currentColor" strokeWidth="1.5" />
                    {/* Hands */}
                    <path d="M14 100 Q12 110 14 115" fill="none" stroke="currentColor" strokeWidth="1.5" />
                    <path d="M66 100 Q68 110 66 115" fill="none" stroke="currentColor" strokeWidth="1.5" />
                    {/* Legs */}
                    <path d="M34 110 L32 156 Q30 180 32 195" fill="none" stroke="currentColor" strokeWidth="1.5" />
                    <path d="M46 110 L48 156 Q50 180 48 195" fill="none" stroke="currentColor" strokeWidth="1.5" />
                    {/* Feet */}
                    <path d="M32 195 L28 205 H36 Z" fill="none" stroke="currentColor" strokeWidth="1.5" />
                    <path d="M48 195 L44 205 H52 Z" fill="none" stroke="currentColor" strokeWidth="1.5" />

                    {!isFront && <path d="M40 44 Q38 70 40 96 Q42 124 40 140" fill="none" stroke="currentColor" strokeWidth="1" strokeDasharray="4 3" opacity="0.5" />}
                    {!isFront && <path d="M30 104 Q40 108 50 104" fill="none" stroke="currentColor" strokeWidth="1" opacity="0.5" />}

                    {/* Joint Lines */}
                    <JointLine x1={35} y1={36} x2={45} y2={36} /> {/* Neck */}
                    <JointLine x1={22} y1={46} x2={58} y2={46} /> {/* Shoulder */}
                    <JointLine x1={15} y1={72} x2={25} y2={72} /> {/* Elbow L */}
                    <JointLine x1={55} y1={72} x2={65} y2={72} /> {/* Elbow R */}
                    <JointLine x1={12} y1={100} x2={16} y2={100} /> {/* Wrist L */}
                    <JointLine x1={64} y1={100} x2={68} y2={100} /> {/* Wrist R */}
                    <JointLine x1={25} y1={104} x2={55} y2={104} /> {/* Hip */}
                    <JointLine x1={31} y1={156} x2={35} y2={156} /> {/* Knee L */}
                    <JointLine x1={45} y1={156} x2={49} y2={156} /> {/* Knee R */}
                    <JointLine x1={30} y1={195} x2={34} y2={195} /> {/* Ankle L */}
                    <JointLine x1={46} y1={195} x2={50} y2={195} /> {/* Ankle R */}
                </svg>
            );
        };

        // --- Main Component ---

        function PainNavigatorApp() {
            const [step, setStep] = useState(1);
            const totalInputSteps = 2;

            const [side, setSide] = useState("front");
            const [regions, setRegions] = useState([]);
            const [qualities, setQualities] = useState([]);
            const [intensity, setIntensity] = useState(4);
            const [duration, setDuration] = useState(DURATION_OPTIONS[0]);
            const [notes, setNotes] = useState("");
            const [showPTDetailsFor, setShowPTDetailsFor] = useState(null);
            const [markers, setMarkers] = useState([]);
            const areaRef = useRef(null);

            const regionLabels = getRegionLabels(side, regions);
            const severity = computeSeverity({ intensity, duration, qualities, notes });
            const generalPlan = makePlan({ severity, regionLabels });
            const issues = makeIssues({ severity, regionLabels, notes, qualities, duration, intensity });
            const areConfidencesEqual = issues.every(i => i.confidence === issues[0].confidence);

            const issuePlans = issues.reduce((acc, issue) => {
                acc[issue.id] = makeIssuePlan({ issueId: issue.id, regionLabels, severity });
                return acc;
            }, {});

            const goNext = () => setStep(s => s + 1);
            const goBack = () => setStep(s => s - 1);
            
            const resetAll = () => {
                setStep(1); setSide("front"); setRegions([]); setQualities([]);
                setIntensity(4); setDuration(DURATION_OPTIONS[0]); setNotes("");
                setShowPTDetailsFor(null); setMarkers([]);
            };

            const handleRegionSelect = (id) => {
                setRegions([id]);
                setMarkers([]);
            };

            const handleAreaClick = (e) => {
                if (!areaRef.current) return;
                const rect = areaRef.current.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                setMarkers(prev => [...prev, { x, y }]);
            };

            const toggleQuality = (value) => {
                if (qualities.includes(value)) setQualities(qualities.filter(v => v !== value));
                else setQualities([...qualities, value]);
            };

            useEffect(() => { window.scrollTo(0,0); }, [step]);

            return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center py-6 px-4 md:px-6">
                    <div className="w-full max-w-4xl bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
                        
                        <header className="px-6 py-4 bg-white border-b border-slate-100 flex items-center justify-between sticky top-0 z-10">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-lg bg-sky-600 flex items-center justify-center text-white font-bold shadow-sm">
                                    <LucideActivity className="w-5 h-5" />
                                </div>
                                <div><h1 className="text-sm font-bold text-slate-900 leading-tight">Physical Therapy Guide</h1></div>
                            </div>
                        </header>

                        <div className="p-6 md:p-8">
                            {step === 1 && (
                                <div className="animate-in fade-in slide-in-from-bottom-4">
                                    <StepHeader step={1} total={totalInputSteps} title="Where does it hurt?" />
                                    <div className="grid md:grid-cols-2 gap-8 md:gap-12 mt-6">
                                        <div className="flex flex-col items-center">
                                            <h3 className="text-sm font-semibold text-slate-700 mb-4 w-full text-center">1. Select Region</h3>
                                            <div className="relative">
                                                <div className="w-48 h-80 bg-slate-50 rounded-3xl flex flex-col items-center justify-center border border-slate-200 shadow-inner">
                                                    <div className="w-32 h-64 flex items-center justify-center relative z-0">
                                                        <BodySilhouette side={side} highlightRegion={regions[0]} />
                                                    </div>
                                                </div>
                                                <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex bg-white rounded-full shadow-md border border-slate-200 p-1">
                                                    <button onClick={() => setSide("front")} className={`px-3 py-1 text-xs font-medium rounded-full transition-all ${side === "front" ? "bg-slate-800 text-white shadow-sm" : "text-slate-500 hover:text-slate-800"}`}>Front</button>
                                                    <button onClick={() => setSide("back")} className={`px-3 py-1 text-xs font-medium rounded-full transition-all ${side === "back" ? "bg-slate-800 text-white shadow-sm" : "text-slate-500 hover:text-slate-800"}`}>Back</button>
                                                </div>
                                            </div>
                                            <div className="mt-6 w-full max-w-sm grid grid-cols-2 gap-2">
                                                {getRegionsForSide(side).map((r) => (
                                                    <button key={r.id} onClick={() => handleRegionSelect(r.id)} className={`text-xs py-2 px-3 rounded-lg border transition-all text-left truncate ${regions.includes(r.id) ? "border-sky-600 bg-sky-50 text-sky-800 font-medium shadow-sm ring-1 ring-sky-200" : "border-slate-200 bg-white text-slate-600 hover:border-slate-300"}`}>{r.label}</button>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="flex flex-col items-center border-t md:border-t-0 md:border-l border-slate-100 pt-8 md:pt-0 md:pl-12 min-h-[400px]">
                                            <h3 className="text-sm font-semibold text-slate-700 mb-4 w-full text-center">2. Pinpoint Specific Spot</h3>
                                            {!regions.length ? (
                                                <div className="flex-1 flex flex-col items-center justify-center text-center p-8 bg-slate-50 rounded-3xl border border-dashed border-slate-300 w-full">
                                                    <div className="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-sm mb-3">
                                                        <LucideAlertCircle className="w-6 h-6 text-slate-300" />
                                                    </div>
                                                    <p className="text-sm text-slate-500">Select a region on the left to activate the zoomed view.</p>
                                                </div>
                                            ) : (
                                                <div className="flex flex-col items-center w-full animate-in zoom-in-95">
                                                    <div className="relative group">
                                                        <div className="absolute -inset-4 bg-sky-100/50 rounded-full blur-xl opacity-0 group-hover:opacity-100 transition duration-500"></div>
                                                        <div ref={areaRef} onClick={handleAreaClick} className="relative w-56 h-80 rounded-3xl bg-white border-2 border-sky-100 shadow-lg cursor-crosshair overflow-hidden">
                                                            <div className="absolute inset-0 flex items-center justify-center opacity-80 pointer-events-none">
                                                                <div className={`w-full h-full transform transition-transform duration-500 ease-in-out flex items-center justify-center ${getZoomStyle(regions[0])}`}>
                                                                    <BodySilhouette side={side} highlightRegion={regions[0]} />
                                                                </div>
                                                            </div>
                                                            {markers.map((m, idx) => (
                                                                <div key={idx} className="absolute w-4 h-4 -ml-2 -mt-2 rounded-full bg-rose-500 shadow-md ring-2 ring-white animate-bounce-short" style={{ left: `${m.x}%`, top: `${m.y}%` }} />
                                                            ))}
                                                            <div className="absolute bottom-3 left-0 right-0 text-center pointer-events-none">
                                                                <span className="bg-white/90 backdrop-blur px-3 py-1 rounded-full text-[10px] font-medium text-slate-500 border shadow-sm">Tap to mark pain</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="mt-6 flex flex-col items-center w-full">
                                                        <div className="text-center mb-4">
                                                            <p className="text-sm font-medium text-slate-900">{regionLabels[0]}</p>
                                                            <p className="text-xs text-slate-500">{markers.length > 0 ? "Pain point marked" : "Tap diagram to mark exact spot"}</p>
                                                        </div>
                                                        <button onClick={() => setMarkers([])} disabled={markers.length === 0} className={`text-xs underline mb-4 ${markers.length === 0 ? "text-slate-300" : "text-slate-500 hover:text-slate-800"}`}>Clear markers</button>
                                                        <button onClick={goNext} className="w-full max-w-xs py-3 rounded-xl bg-slate-900 text-white text-sm font-semibold hover:bg-slate-800 hover:shadow-lg hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 group">
                                                            Continue
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="group-hover:translate-x-1 transition-transform"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {step === 2 && (
                                <div className="max-w-2xl mx-auto animate-in fade-in slide-in-from-right-8">
                                    <StepHeader step={2} total={totalInputSteps} title="Describe the feeling" />
                                    <div className="space-y-8 mt-6">
                                        <section className="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                            <h3 className="text-sm font-semibold text-slate-900 mb-3 flex items-center gap-2">
                                                <LucideInfo className="w-4 h-4 text-sky-600"/> What does it feel like?
                                            </h3>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                                {PAIN_QUALITIES.map((q) => (
                                                    <Chip key={q} selected={qualities.includes(q)} onClick={() => toggleQuality(q)}>{q}</Chip>
                                                ))}
                                            </div>
                                        </section>
                                        <section className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                                                <div className="flex items-center justify-between mb-4">
                                                    <span className="text-sm font-medium text-slate-700">Intensity</span>
                                                    <span className={`text-sm font-bold px-2 py-1 rounded bg-slate-100 ${intensity > 7 ? "text-rose-600" : "text-slate-900"}`}>{intensity} / 10</span>
                                                </div>
                                                <input type="range" min={0} max={10} step={1} value={intensity} onChange={(e) => setIntensity(Number(e.target.value))} className="w-full accent-sky-600 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                                                <div className="flex justify-between text-[10px] text-slate-400 mt-2 font-medium"><span>Mild</span><span>Moderate</span><span>Severe</span></div>
                                            </div>
                                            <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                                                <span className="text-sm font-medium text-slate-700 mb-2 block">Duration</span>
                                                <div className="space-y-2">
                                                    {DURATION_OPTIONS.map((opt) => (
                                                        <label key={opt} className="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50 cursor-pointer border border-transparent hover:border-slate-200 transition-all">
                                                            <input type="radio" name="duration" value={opt} checked={duration === opt} onChange={(e) => setDuration(e.target.value)} className="w-4 h-4 text-sky-600 border-slate-300 focus:ring-sky-500" />
                                                            <span className="text-sm text-slate-700">{opt}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                        </section>
                                        <section>
                                            <h3 className="text-sm font-semibold text-slate-900 mb-2">Additional Details</h3>
                                            <textarea className="w-full p-4 text-sm border border-slate-200 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-transparent outline-none transition shadow-sm resize-none" rows={3} placeholder="E.g., It hurts when I run, feels stiff in morning, or pops when I stand up..." value={notes} onChange={(e) => setNotes(e.target.value)} />
                                        </section>
                                    </div>
                                    <div className="flex justify-between mt-10 pt-6 border-t border-slate-100">
                                        <button type="button" onClick={goBack} className="px-6 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-800 transition">Back</button>
                                        <button type="button" onClick={goNext} className="px-8 py-3 rounded-xl bg-sky-600 text-white text-sm font-semibold hover:bg-sky-700 shadow-lg hover:shadow-sky-200 transition-all transform hover:-translate-y-0.5">See Treatments</button>
                                    </div>
                                </div>
                            )}

                            {step === 3 && (
                                <div className="animate-in fade-in slide-in-from-bottom-8">
                                    <div className="text-center mb-8">
                                        <div className={`inline-flex items-center justify-center p-3 rounded-full mb-4 ${severity === 'orange' ? 'bg-orange-100 text-orange-600' : 'bg-emerald-100 text-emerald-700'}`}>
                                            {severity === 'orange' ? <LucideAlertTriangle className="w-8 h-8"/> : <LucideCheckCircle2 className="w-8 h-8" />}
                                        </div>
                                        <h2 className="text-2xl font-bold text-slate-900">Possible treatments</h2>
                                        <p className="text-slate-500 mt-2">Based on your input for {regionLabels[0] || "your body"}</p>
                                    </div>

                                    <SeverityBadge level={severity} />

                                    <div className="grid lg:grid-cols-3 gap-8 mt-8">
                                        <div className="lg:col-span-2 space-y-6">
                                            <h3 className="text-lg font-bold text-slate-900 flex items-center gap-2">Primary Contributing Factors</h3>
                                            <div className="space-y-4">
                                                {issues.map((issue, idx) => {
                                                    const isPrimary = idx === 0;
                                                    const isExpanded = showPTDetailsFor === issue.id;
                                                    if (isPrimary) {
                                                        return (
                                                            <div key={issue.id} className="rounded-2xl border border-sky-100 bg-gradient-to-br from-white to-sky-50 p-6 shadow-sm relative overflow-hidden group">
                                                                <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><div className="w-24 h-24 rounded-full bg-sky-400 blur-2xl"></div></div>
                                                                <div className="flex justify-between items-start mb-3 relative z-10">
                                                                    <div className="flex items-center gap-3">
                                                                        <span className="bg-sky-600 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">Top Match</span>
                                                                        {!areConfidencesEqual && <span className="text-xs font-semibold text-sky-700">{issue.confidence}% Confidence</span>}
                                                                    </div>
                                                                </div>
                                                                <div className="mb-5 relative z-10"><h4 className="text-xl font-bold text-slate-900 mb-2">{issue.title}</h4><p className="text-sm text-slate-600 leading-relaxed">{issue.description}</p></div>
                                                                <div className="bg-white/60 backdrop-blur rounded-xl p-4 border border-sky-100 mb-5 relative z-10"><div className="text-xs font-bold text-sky-900 uppercase tracking-wide mb-1">Quick Focus</div><div className="text-sm font-medium text-slate-800">{issue.remedyShort}</div></div>
                                                                <button type="button" onClick={() => setShowPTDetailsFor(isExpanded ? null : issue.id)} className="w-full py-3 bg-sky-600 hover:bg-sky-700 text-white rounded-xl text-sm font-semibold transition relative z-10 shadow-md hover:shadow-lg">{isExpanded ? "Hide Full Plan" : "View Full Home Plan"}</button>
                                                                {isExpanded && (
                                                                    <div className="mt-6 pt-6 border-t border-sky-200/50 animate-in fade-in slide-in-from-top-2 relative z-10">
                                                                        <h5 className="font-bold text-slate-900 text-sm mb-3">Step-by-step Routine:</h5>
                                                                        <ol className="space-y-3">
                                                                            {issuePlans[issue.id]?.map((stepText, i) => (
                                                                                <li key={i} className="flex gap-3 text-sm text-slate-700 bg-white p-3 rounded-lg border border-sky-100"><span className="flex-shrink-0 w-5 h-5 bg-sky-100 text-sky-700 rounded-full flex items-center justify-center text-xs font-bold mt-0.5">{i+1}</span>{stepText}</li>
                                                                            ))}
                                                                        </ol>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    }
                                                    return (
                                                        <div key={issue.id} className="rounded-xl border border-slate-200 bg-white p-4 hover:border-slate-300 transition">
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex-1 pr-4">
                                                                    <div className="flex items-center gap-2 mb-1">{!areConfidencesEqual && <span className="text-xs font-bold text-slate-400">{issue.confidence}% Match</span>}</div>
                                                                    <h4 className="text-base font-bold text-slate-900">{issue.title}</h4>
                                                                    <div className="text-xs text-slate-500 mt-1">Try: <span className="font-medium text-slate-700">{issue.remedyShort}</span></div>
                                                                </div>
                                                                <button onClick={() => setShowPTDetailsFor(isExpanded ? null : issue.id)} className="text-xs font-semibold text-slate-600 hover:text-sky-600 px-4 py-2 bg-slate-50 hover:bg-sky-50 rounded-lg transition">{isExpanded ? "Close" : "Details"}</button>
                                                            </div>
                                                            {isExpanded && (
                                                                <div className="mt-4 pt-4 border-t border-slate-100">
                                                                    <p className="text-xs text-slate-500 mb-4 italic leading-relaxed">{issue.description}</p>
                                                                    <ol className="space-y-2">
                                                                        {issuePlans[issue.id]?.map((stepText, i) => (
                                                                            <li key={i} className="text-xs text-slate-700 flex gap-2"><span className="text-slate-400 font-bold">•</span>{stepText}</li>
                                                                        ))}
                                                                    </ol>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                        <div className="lg:col-span-1">
                                            <div className="sticky top-24 bg-slate-900 rounded-2xl p-6 text-slate-300 shadow-xl">
                                                <h3 className="text-white font-bold text-lg mb-4 border-b border-slate-700 pb-4">{generalPlan.title}</h3>
                                                <ul className="space-y-4">
                                                    {generalPlan.steps.map((s, i) => (
                                                        <li key={i} className="flex gap-3 text-sm leading-relaxed"><div className={`w-1.5 h-1.5 rounded-full mt-2 flex-shrink-0 ${severity === 'orange' ? 'bg-orange-400' : 'bg-emerald-400'}`}></div><span>{s}</span></li>
                                                    ))}
                                                </ul>
                                                <div className="mt-8 pt-6 border-t border-slate-800">
                                                    <button onClick={resetAll} className="w-full py-3 rounded-xl bg-slate-800 text-white text-sm font-semibold hover:bg-slate-700 transition">Start Over</button>
                                                    <button onClick={goBack} className="w-full mt-3 text-xs text-slate-500 hover:text-white transition text-center">Edit answers</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<PainNavigatorApp />);
    </script>
</body>
</html>
